<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal Sabzi Chef Chatbot</title>
    <!-- Google AdSense script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7869508688913658"
        crossorigin="anonymous"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Baloo+Bhai+2:wght@600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', 'Baloo Bhai 2', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            animation: bgmove 10s linear infinite alternate;
        }
        @keyframes bgmove {
            0% { background-position: 0 0; }
            100% { background-position: 100% 100%; }
        }
        .chat-container {
            width: 100%;
            max-width: 480px;
            height: 92vh;
            background: #fff;
            box-shadow: 0 8px 32px rgba(44, 120, 72, 0.18);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .chat-header {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: #fff;
            padding: 22px 20px 18px 20px;
            font-size: 1.7em;
            font-family: 'Baloo Bhai 2', cursive;
            font-weight: 600;
            text-align: center;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(44, 120, 72, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .chat-header .sabzi-icon {
            font-size: 1.5em;
            filter: drop-shadow(0 2px 2px #2e7d32aa);
        }
        .chat-messages {
            flex-grow: 1;
            padding: 24px 18px 18px 18px;
            overflow-y: auto;
            background: linear-gradient(120deg, #e8f5e9 60%, #f1f8e9 100%);
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.5s;
        }
        .message {
            margin-bottom: 18px;
            display: flex;
            align-items: flex-end;
            animation: fadeInUp 0.5s;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-bubble {
            max-width: 80%;
            padding: 15px 22px;
            border-radius: 22px;
            line-height: 1.6;
            word-wrap: break-word;
            box-shadow: 0 2px 12px rgba(44, 120, 72, 0.07);
            font-size: 1.08em;
            transition: background 0.3s;
        }
        .message.bot .message-bubble {
            background: linear-gradient(120deg, #b2f7ef 60%, #e0f7fa 100%);
            color: #1b5e20;
            border-bottom-left-radius: 6px;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.user .message-bubble {
            background: linear-gradient(120deg, #43e97b 60%, #38f9d7 100%);
            color: #fff;
            border-bottom-right-radius: 6px;
        }
        .input-area {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
        }
        .input-area input[type="text"] {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1.5px solid #a5d6a7;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            margin-right: 10px;
            background: #f1f8e9;
            transition: border 0.3s;
        }
        .input-area input[type="text"]:focus {
            border: 1.5px solid #43e97b;
        }
        .input-area button {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 22px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px #43e97b33;
            transition: background 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-area button:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            box-shadow: 0 4px 16px #43e97b44;
        }
        .options-area {
            padding: 12px 20px 18px 20px;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            display: none;
        }
        .option-button {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border: none;
            border-radius: 22px;
            padding: 12px 22px;
            font-size: 1.08em;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px #43e97b22;
            transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeInUp 0.4s;
            width: 100%;
            justify-content: center;
        }
        .option-button:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            box-shadow: 0 4px 16px #43e97b44;
            transform: translateY(-2px) scale(1.04);
        }
        .main-action-button {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 16px 24px;
            font-size: 1.15em;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px #43e97b33;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .main-action-button:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            box-shadow: 0 4px 16px #43e97b44;
        }
        .back-button {
            background: #f44336;
        }
        .back-button:hover {
            background: #da190b;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 12px;
            border-radius: 12px;
            background: #f1f8e9;
            margin-top: 10px;
        }
        .checkbox-group label {
            margin-bottom: 7px;
            cursor: pointer;
            padding: 7px 0;
            display: flex;
            align-items: center;
            font-size: 1.05em;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        .checkbox-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 18px;
            gap: 12px;
        }
        .checkbox-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 1.08em;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }
        .checkbox-buttons .save-button {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        .checkbox-buttons .save-button:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
        }
        .checkbox-buttons .back-button-small {
            background: #6c757d;
            color: white;
        }
        .checkbox-buttons .back-button-small:hover {
            background: #5a6268;
        }
        .loading-dots {
            display: inline-block;
            position: relative;
            width: 40px;
            height: 20px;
            text-align: center;
        }
        .loading-dots div {
            display: inline-block;
            position: absolute;
            left: 8px;
            width: 8px;
            background: #43e97b;
            animation: loading 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
        }
        .loading-dots div:nth-child(1) {
            left: 8px;
            animation-delay: -0.24s;
        }
        .loading-dots div:nth-child(2) {
            left: 20px;
            animation-delay: -0.12s;
        }
        .loading-dots div:nth-child(3) {
            left: 32px;
            animation-delay: 0s;
        }
        @keyframes loading {
            0% { top: 8px; height: 16px; }
            50%, 100% { top: 12px; height: 8px; }
        }
        /* Seasonal Veggies Card Grid */
        .seasonal-veg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 14px;
            margin: 18px 0 8px 0;
        }
        .seasonal-veg-card {
            background: linear-gradient(120deg, #e0f7fa 60%, #b2f7ef 100%);
            border-radius: 14px;
            box-shadow: 0 2px 8px #43e97b22;
            padding: 14px 10px;
            text-align: center;
            font-size: 1.08em;
            color: #1b5e20;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: fadeInUp 0.5s;
        }
        .seasonal-veg-card:hover {
            transform: scale(1.06) translateY(-2px);
            box-shadow: 0 4px 16px #43e97b44;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            background: #e0f2f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a5d6a7;
            border-radius: 8px;
        }
        @media (max-width: 600px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
            }
            .chat-header {
                border-top-left-radius: 0;
                border-top-right-radius: 0;
                font-size: 1.2em;
                padding: 16px 8px 12px 8px;
            }
            .chat-messages {
                padding: 12px 4px 10px 4px;
            }
            .input-area, .options-area {
                padding: 8px 4px;
            }
            .options-area {
                display: flex !important;
                flex-wrap: wrap;
                gap: 8px;
                width: 100%;
                padding: 8px 4px !important;
            }
            .option-button {
                width: 100% !important;
                min-width: 0 !important;
                max-width: 100% !important;
                font-size: 1.1em !important;
                margin: 0 0 8px 0 !important;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <span class="sabzi-icon">ðŸ¥¦</span> My Personal Sabzi Chef
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Welcome message will be shown here -->
            </div>
        <div class="options-area" id="options-area">
            <!-- Authentication buttons will be shown here initially -->
            </div>
        <div class="input-area" id="input-area">
            <input type="text" id="user-input" placeholder="Type your message..." style="display: none;">
            <button id="send-button" style="display: none;">Send</button>
            <input type="text" id="new-member-name-input" placeholder="Enter new member name..." style="display: none;">
            <button id="next-button" style="display: none;">Next</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const optionsArea = document.getElementById('options-area');
        const inputArea = document.getElementById('input-area');
        const newMemberNameInput = document.getElementById('new-member-name-input');
        const nextButton = document.getElementById('next-button');
        
        const BASE_URL = window.location.origin;

        let currentFlow = 'auth'; // 'auth', 'main_menu', 'manage_family_choice', 'select_existing_member', 'enter_new_member_name', 'select_veg', 'select_present_members'
        let currentMemberName = '';
        let allVegetables = [];
        let memberVegetableCheckboxes = {};
        let isLoggedIn = false;
        let currentAuthStep = ''; // 'login', 'register', 'forgot_password', 'otp_verification', 'reset_password'
        let forgotPasswordEmail = '';

        // --- Helper Functions ---
        
        // Better bubble management functions
        function removeAllFormBubbles() {
            const allBotMessages = chatMessages.querySelectorAll('.message.bot');
            allBotMessages.forEach(msg => {
                if (msg.querySelector('input') || msg.querySelector('button')) {
                    msg.remove();
                }
            });
        }
        
        function removeLastErrorBubble() {
            const allBotMessages = chatMessages.querySelectorAll('.message.bot');
            if (allBotMessages.length > 0) {
                const last = allBotMessages[allBotMessages.length - 1];
                // Remove if it's just a text message (no form elements)
                if (!last.querySelector('input') && !last.querySelector('button')) {
                    last.remove();
                }
            }
        }
        
        function showError(message) {
            removeLastErrorBubble();
            appendMessage('bot', message);
        }
        
        // Validation functions
        function validateMobileNumber(mobile) {
            // Remove any spaces, dashes, or other characters
            const cleanMobile = mobile.replace(/\D/g, '');
            
            // Check if it's exactly 10 digits
            if (!/^\d{10}$/.test(cleanMobile)) {
                return { valid: false, message: 'Please enter exactly 10 digits.' };
            }
            
            // Check if it starts with valid Indian mobile prefixes (6, 7, 8, 9)
            const firstDigit = cleanMobile.charAt(0);
            if (!['6', '7', '8', '9'].includes(firstDigit)) {
                return { valid: false, message: 'Mobile number should start with 6, 7, 8, or 9.' };
            }
            
            // Check for repeated digits pattern (like 2222222222, 1111111111)
            const allSameDigits = /^(\d)\1{9}$/.test(cleanMobile);
            if (allSameDigits) {
                return { valid: false, message: 'Please enter a valid mobile number (repeated digits not allowed).' };
            }
            
            // Check for sequential patterns (like 1234567890, 9876543210)
            const isSequential = /^(0123456789|1234567890|9876543210|0987654321)$/.test(cleanMobile);
            if (isSequential) {
                return { valid: false, message: 'Please enter a valid mobile number (sequential patterns not allowed).' };
            }
            
            return { valid: true, message: '' };
        }
        
        function validateEmail(email) {
            // Basic email validation regex
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { valid: false, message: 'Please enter a valid email address format.' };
            }
            
            // Check for common email providers
            const commonProviders = [
                'gmail.com', 'yahoo.com', 'yahoo.in', 'hotmail.com', 'outlook.com',
                'rediffmail.com', 'aol.com', 'icloud.com', 'protonmail.com', 'zoho.com'
            ];
            
            const domain = email.split('@')[1].toLowerCase();
            if (!commonProviders.includes(domain)) {
                return { valid: false, message: 'Please use a common email provider (Gmail, Yahoo, Hotmail, etc.) or contact support for private domains.' };
            }
            
            return { valid: true, message: '' };
        }

        function appendMessage(sender, message, options = [], customHtml = '') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');
            if (customHtml) {
                bubbleDiv.innerHTML = customHtml;
            } else if (typeof message === 'string' && message.includes('\n') && sender === 'bot' && message.startsWith('Current season vegetables')) {
                const lines = message.split('\n').filter(x => x.trim() !== '');
                if (lines.length > 1) {
                    const vegList = lines.slice(1).join(' ').split(',').map(x => x.trim()).filter(x => x);
                    let gridHtml = '<div class="seasonal-veg-grid">';
                    vegList.forEach(veg => {
                        gridHtml += `<div class="seasonal-veg-card">${veg}</div>`;
                    });
                    gridHtml += '</div>';
                    bubbleDiv.innerHTML = `<div style="font-weight:600;margin-bottom:8px;">${lines[0]}</div>` + gridHtml;
                } else {
                    bubbleDiv.textContent = message;
                }
            } else if (typeof message === 'string' && message.includes('\n')) {
                const parts = message.split('\n');
                parts.forEach(part => {
                    if (part.trim() !== '') {
                        const p = document.createElement('p');
                        p.textContent = part.trim();
                        bubbleDiv.appendChild(p);
                    }
                });
            } else {
                bubbleDiv.textContent = message;
            }
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            displayOptions(options);
        }

        function displayOptions(options) {
            optionsArea.innerHTML = '';
            if (options.length > 0) {
                optionsArea.style.display = 'flex';
                options.forEach(optionText => {
                    const button = document.createElement('button');
                    button.classList.add('option-button');
                    button.textContent = optionText;
                    if (!isLoggedIn && currentFlow !== 'auth') {
                        button.disabled = true;
                        button.style.opacity = 0.6;
                        button.title = 'Please log in to use this feature.';
                        button.onclick = () => alert('Please log in to use this feature.');
                    } else {
                        button.onclick = () => handleOptionClick(optionText);
                    }
                    optionsArea.appendChild(button);
                });
            } else {
                optionsArea.style.display = 'none';
            }
        }

        function toggleInput(showUserInput = false, showNewMemberInput = false) {
            userInput.style.display = showUserInput ? 'block' : 'none';
            sendButton.style.display = showUserInput ? 'block' : 'none';
            newMemberNameInput.style.display = showNewMemberInput ? 'block' : 'none';
            nextButton.style.display = showNewMemberInput ? 'block' : 'none';

            if (showUserInput) userInput.focus();
            if (showNewMemberInput) newMemberNameInput.focus();
        }

        function appendLoadingDots() {
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('message', 'bot');
            loadingDiv.id = 'loading-message';
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');
            bubbleDiv.innerHTML = `<div class="loading-dots"><div></div><div></div><div></div></div>`;
            loadingDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingDots() {
            const loadingDiv = document.getElementById('loading-message');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        async function fetchAPI(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                if (data) {
                    options.body = JSON.stringify(data);
                }
                appendLoadingDots();
                const response = await fetch(`${BASE_URL}${endpoint}`, options);
                removeLoadingDots();
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Something went wrong with the API call.');
                }
                return await response.json();
            } catch (error) {
                removeLoadingDots();
                appendMessage('bot', `Oops! An error occurred: ${error.message}. Please try again.`);
                console.error('API Error:', error);
                return { status: 'error', message: error.message }; 
            }
        }

        // --- Authentication Chat Bubble Functions ---

        // Show initial auth options
        function showAuthScreen() {
            currentFlow = 'auth';
            isLoggedIn = false;
            chatMessages.innerHTML = '';
            appendMessage('bot', "Welcome to My Personal Sabzi Chef! ðŸ¥¦\n\nPlease choose an option to continue:");
            displayOptions(["Login", "New User"]);
        }

        // Show login form as chat bubble
        function showLoginForm() {
            currentAuthStep = 'login';
            removeAllFormBubbles();
            // Extra safety: hide and clear options area
            optionsArea.innerHTML = '';
            optionsArea.style.display = 'none';
            displayOptions([]);
            appendMessage('bot', '', [], `
                <div>
                    <div style="margin-bottom:8px;">Please enter your login details:</div>
                    <input type="text" id="login-mobile" placeholder="Mobile Number" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;" onblur="validateLoginMobile()">
                    <div id="login-mobile-error" style="color:#d32f2f;font-size:0.85em;margin-bottom:8px;display:none;"></div>
                    <input type="password" id="login-password" placeholder="Password" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;">
                    <div id="login-form-error" style="color:#d32f2f;font-size:0.95em;margin-bottom:8px;display:none;"></div>
                    <button id="login-submit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);color:#fff;font-weight:600;font-size:1.1em;border:none;">Login</button>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="switch-to-register" style="padding:8px 16px;border-radius:6px;background:#6c757d;color:#fff;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">New User? Register here</button>
                    </div>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="login-forgot" style="padding:6px 14px;border-radius:6px;background:#e0e0e0;color:#388e3c;font-weight:500;font-size:0.95em;border:none;cursor:pointer;margin-bottom:6px;">Forgot Password?</button>
                    </div>
                </div>
            `);
            setTimeout(() => {
                document.getElementById('login-submit').onclick = async function() {
                    // Clear all error divs
                    document.getElementById('login-mobile-error').style.display = 'none';
                    document.getElementById('login-form-error').style.display = 'none';
                    document.getElementById('login-mobile-error').textContent = '';
                    document.getElementById('login-form-error').textContent = '';

                    const mobile = document.getElementById('login-mobile').value.trim();
                    const password = document.getElementById('login-password').value.trim();

                    if (!mobile || !password) {
                        const errorDiv = document.getElementById('login-form-error');
                        errorDiv.textContent = 'Please fill in all fields.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    if (!validateMobileNumber(mobile).valid) {
                        const errorDiv = document.getElementById('login-mobile-error');
                        errorDiv.textContent = validateMobileNumber(mobile).message;
                        errorDiv.style.display = 'block';
                        return;
                    }

                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mobile_number: mobile, password: password })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        showMainMenuAfterAuthSuccess('Login successful! Please continue.');
                    } else {
                        const errorDiv = document.getElementById('login-form-error');
                        errorDiv.textContent = 'Invalid credentials. Try Again.';
                        errorDiv.style.display = 'block';
                    }
                };
                document.getElementById('switch-to-register').onclick = showRegisterForm;
                document.getElementById('login-forgot').onclick = showForgotPasswordForm;
            }, 0);
        }

        // Real-time validation functions
        function validateLoginMobile() {
            const mobile = document.getElementById('login-mobile').value.trim();
            const errorDiv = document.getElementById('login-mobile-error');
            
            if (mobile.length === 0) {
                errorDiv.style.display = 'none';
                return;
            }
            
            const validation = validateMobileNumber(mobile);
            if (!validation.valid) {
                errorDiv.textContent = validation.message;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        // Show register form as chat bubble
        function showRegisterForm() {
            currentAuthStep = 'register';
            removeAllFormBubbles();
            // Extra safety: hide and clear options area
            optionsArea.innerHTML = '';
            optionsArea.style.display = 'none';
            displayOptions([]);
            appendMessage('bot', '', [], `
                <div>
                    <div style="margin-bottom:8px;">Please enter your registration details:</div>
                    <input type="text" id="register-mobile" placeholder="Mobile Number" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;" onblur="validateRegisterMobile()">
                    <div id="register-mobile-error" style="color:#d32f2f;font-size:0.85em;margin-bottom:8px;display:none;"></div>
                    <input type="email" id="register-email" placeholder="Email" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;" onblur="validateRegisterEmail()">
                    <div id="register-email-error" style="color:#d32f2f;font-size:0.85em;margin-bottom:8px;display:none;"></div>
                    <input type="password" id="register-password" placeholder="Password" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;">
                    <div id="register-password-error" style="color:#d32f2f;font-size:0.85em;margin-bottom:8px;display:none;"></div>
                    <button id="register-submit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);color:#fff;font-weight:600;font-size:1.1em;border:none;">Register</button>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="switch-to-login" style="padding:8px 16px;border-radius:6px;background:#6c757d;color:#fff;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">Already have account? Login here</button>
                    </div>
                </div>
            `);
            setTimeout(() => {
                document.getElementById('register-submit').onclick = async function() {
                    // Clear all error divs
                    document.getElementById('register-mobile-error').style.display = 'none';
                    document.getElementById('register-email-error').style.display = 'none';
                    document.getElementById('register-password-error').style.display = 'none';
                    document.getElementById('register-mobile-error').textContent = '';
                    document.getElementById('register-email-error').textContent = '';
                    document.getElementById('register-password-error').textContent = '';

                    const mobile = document.getElementById('register-mobile').value.trim();
                    const email = document.getElementById('register-email').value.trim();
                    const password = document.getElementById('register-password').value.trim();

                    // Mobile validation
                    const mobileValidation = validateMobileNumber(mobile);
                    if (!mobileValidation.valid) {
                        const errorDiv = document.getElementById('register-mobile-error');
                        errorDiv.textContent = mobileValidation.message;
                        errorDiv.style.display = 'block';
                        return;
                    }

                    // Email validation
                    const emailValidation = validateEmail(email);
                    if (!emailValidation.valid) {
                        const errorDiv = document.getElementById('register-email-error');
                        errorDiv.textContent = emailValidation.message;
                        errorDiv.style.display = 'block';
                        return;
                    }

                    // Password validation (optional, e.g. min length)
                    if (!password) {
                        const errorDiv = document.getElementById('register-password-error');
                        errorDiv.textContent = 'Please enter a password.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mobile_number: mobile, email: email, password: password })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        showMainMenuAfterAuthSuccess('Registration successful! Please continue.');
                    } else {
                        // Show server error in a suitable place (e.g. mobile/email/password error div or as an alert)
                        // For now, show in mobile error div if it's about mobile, email error div if about email, else password error div
                        if (data.message && data.message.toLowerCase().includes('mobile')) {
                            const errorDiv = document.getElementById('register-mobile-error');
                            errorDiv.textContent = data.message;
                            errorDiv.style.display = 'block';
                        } else if (data.message && data.message.toLowerCase().includes('email')) {
                            const errorDiv = document.getElementById('register-email-error');
                            errorDiv.textContent = data.message;
                            errorDiv.style.display = 'block';
                        } else {
                            const errorDiv = document.getElementById('register-password-error');
                            errorDiv.textContent = data.message;
                            errorDiv.style.display = 'block';
                        }
                    }
                };
                document.getElementById('switch-to-login').onclick = showLoginForm;
            }, 0);
        }

        // Real-time validation functions for registration
        function validateRegisterMobile() {
            const mobile = document.getElementById('register-mobile').value.trim();
            const errorDiv = document.getElementById('register-mobile-error');
            
            if (mobile.length === 0) {
                errorDiv.style.display = 'none';
                return;
            }
            
            const validation = validateMobileNumber(mobile);
            if (!validation.valid) {
                errorDiv.textContent = validation.message;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value.trim();
            const errorDiv = document.getElementById('register-email-error');
            
            if (email.length === 0) {
                errorDiv.style.display = 'none';
                return;
            }
            
            const validation = validateEmail(email);
            if (!validation.valid) {
                errorDiv.textContent = validation.message;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        // Show forgot password form as chat bubble
        function showForgotPasswordForm() {
            currentAuthStep = 'forgot_password';
            removeAllFormBubbles();
            // Extra safety: hide and clear options area
            optionsArea.innerHTML = '';
            optionsArea.style.display = 'none';
            displayOptions([]);
            appendMessage('bot', '', [], `
                <div>
                    <div style="margin-bottom:8px;">Please enter your email address to receive OTP:</div>
                    <input type="email" id="forgot-email" placeholder="Email" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;">
                    <button id="forgot-submit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);color:#fff;font-weight:600;font-size:1.1em;border:none;">Send OTP</button>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="back-to-login" style="padding:8px 16px;border-radius:6px;background:#6c757d;color:#fff;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">Back to Login</button>
                    </div>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="goto-register" style="padding:8px 16px;border-radius:6px;background:#e0e0e0;color:#388e3c;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">New User? Register here</button>
                    </div>
                </div>
            `);
            setTimeout(() => {
                document.getElementById('forgot-submit').onclick = async function() {
                    const email = document.getElementById('forgot-email').value.trim();
                    if (!email) {
                        showError('Please enter your email address.');
                        return;
                    }
                    const response = await fetch('/forgot_password_request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        showOtpForm(email);
                    } else {
                        showError(`Error: ${data.message}`);
                    }
                };
                document.getElementById('back-to-login').onclick = showLoginForm;
                document.getElementById('goto-register').onclick = showRegisterForm;
            }, 0);
        }

        // Show OTP form as chat bubble
        function showOtpForm(email) {
            currentAuthStep = 'otp_verification';
            removeAllFormBubbles();
            // Extra safety: hide and clear options area
            optionsArea.innerHTML = '';
            optionsArea.style.display = 'none';
            displayOptions([]);
            appendMessage('bot', '', [], `
                <div>
                    <div style="margin-bottom:8px;">OTP has been sent to ${email}<br>Please enter the OTP:</div>
                    <input type="text" id="otp-input" placeholder="Enter OTP" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;">
                    <button id="otp-submit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);color:#fff;font-weight:600;font-size:1.1em;border:none;">Verify OTP</button>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="back-to-login" style="padding:8px 16px;border-radius:6px;background:#6c757d;color:#fff;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">Back to Login</button>
                    </div>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="goto-register" style="padding:8px 16px;border-radius:6px;background:#e0e0e0;color:#388e3c;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">New User? Register here</button>
                    </div>
                </div>
            `);
            setTimeout(() => {
                document.getElementById('otp-submit').onclick = async function() {
                    const otp = document.getElementById('otp-input').value.trim();
                    if (!otp) {
                        showError('Please enter the OTP.');
                        return;
                    }
                    const response = await fetch('/verify_otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, otp: otp })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        showResetPasswordForm(email, otp);
                    } else {
                        showError(`Invalid OTP: ${data.message}`);
                    }
                };
                document.getElementById('back-to-login').onclick = showLoginForm;
                document.getElementById('goto-register').onclick = showRegisterForm;
            }, 0);
        }

        // Show reset password form as chat bubble
        function showResetPasswordForm(email, otp) {
            currentAuthStep = 'reset_password';
            removeAllFormBubbles();
            // Extra safety: hide and clear options area
            optionsArea.innerHTML = '';
            optionsArea.style.display = 'none';
            displayOptions([]);
            appendMessage('bot', '', [], `
                <div>
                    <div style="margin-bottom:8px;">Please enter your new password:</div>
                    <input type="password" id="reset-password" placeholder="New Password" style="width:90%;margin-bottom:8px;padding:10px;border-radius:8px;border:1.5px solid #a5d6a7;">
                    <button id="reset-submit" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);color:#fff;font-weight:600;font-size:1.1em;border:none;">Reset Password</button>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="back-to-login" style="padding:8px 16px;border-radius:6px;background:#6c757d;color:#fff;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">Back to Login</button>
                    </div>
                    <div style="margin-top:8px;text-align:center;">
                        <button id="goto-register" style="padding:8px 16px;border-radius:6px;background:#e0e0e0;color:#388e3c;font-weight:500;font-size:0.9em;border:none;cursor:pointer;">New User? Register here</button>
                    </div>
                </div>
            `);
            setTimeout(() => {
                document.getElementById('reset-submit').onclick = async function() {
                    const newPassword = document.getElementById('reset-password').value.trim();
                    if (!newPassword) {
                        showError('Please enter a new password.');
                        return;
                    }
                    const response = await fetch('/reset_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, otp: otp, new_password: newPassword })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        appendMessage('bot', 'Password reset successful! Please login with your new password.');
                        setTimeout(() => showLoginForm(), 1200);
                    } else {
                        showError(`Error: ${data.message}`);
                    }
                };
                document.getElementById('back-to-login').onclick = showLoginForm;
                document.getElementById('goto-register').onclick = showRegisterForm;
            }, 0);
        }

        // --- Chatbot Flow Functions ---
        async function showMainMenu() {
            chatMessages.innerHTML = '';
            currentFlow = 'main_menu';
            toggleInput(false, false);
            appendMessage('bot', "Welcome to My Personal Sabzi Chef! What would you like to do?", 
                ["Manage Family & Favorite Vegetables", "What to Cook Today?", "Current Season Vegetables", "Logout"]);
            currentMemberName = '';
            memberVegetableCheckboxes = {};
        }

        async function handleOptionClick(optionText) {
            appendMessage('user', optionText);

            switch (currentFlow) {
                case 'auth':
                    if (optionText === "Login") {
                        showLoginForm();
                    } else if (optionText === "New User") {
                        showRegisterForm();
                    } else if (optionText === "Try Again") {
                        if (currentAuthStep === 'login') {
                            showLoginForm();
                        } else if (currentAuthStep === 'register') {
                            showRegisterForm();
                        } else if (currentAuthStep === 'forgot_password') {
                            showForgotPasswordForm();
                        } else if (currentAuthStep === 'otp_verification') {
                            showOtpForm();
                        } else if (currentAuthStep === 'reset_password') {
                            showResetPasswordForm();
                        }
                    } else if (optionText === "Forgot Password") {
                        showForgotPasswordForm();
                    }
                    break;
                case 'main_menu':
                    if (optionText === "Manage Family & Favorite Vegetables") {
                        await manageFamilyStartFlow();
                    } else if (optionText === "What to Cook Today?") {
                        await recommendSabziFlow();
                    } else if (optionText === "Current Season Vegetables") {
                        const vegList = await fetchAPI('/api/seasonal_vegetables');
                        if (Array.isArray(vegList) && vegList.length > 0) {
                            appendMessage('bot', `Current season vegetables available in the market:\n\n${vegList.join(', ')}`);
                        } else {
                            appendMessage('bot', 'No seasonal vegetables found or an error occurred.');
                        }
                        currentFlow = 'showing_seasonal_veg';
                        displayOptions(["Back to Main Menu", "What to Cook Today?", "Logout"]);
                    } else if (optionText === "Logout") {
                        appendMessage('bot', "Logged out successfully. Goodbye!");
                        setTimeout(() => showAuthScreen(), 1500);
                    }
                    break;
                case 'showing_seasonal_veg':
                    if (optionText === "Back to Main Menu") {
                        showMainMenu();
                    } else if (optionText === "What to Cook Today?") {
                        await recommendSabziFlow();
                    } else if (optionText === "Logout") {
                        appendMessage('bot', "Logged out successfully. Goodbye!");
                        setTimeout(() => showAuthScreen(), 1500);
                    }
                    break;
                case 'manage_family_choice':
                    if (optionText === "Update Existing Member's Preferences") {
                        await selectExistingMemberFlow();
                    } else if (optionText === "Add New Member") {
                        await addNewMemberNameFlow();
                    } else if (optionText === "Back to Main Menu") {
                        showMainMenu();
                    } else if (optionText === "What to Cook Today?") {
                        await recommendSabziFlow();
                    } else if (optionText === "Logout") {
                        appendMessage('bot', "Logged out successfully. Goodbye!");
                        setTimeout(() => showAuthScreen(), 1500);
                    }
                    break;
                case 'select_existing_member':
                    if (optionText === "Back to Main Menu") {
                        showMainMenu();
                    } else if (optionText === "What to Cook Today?") {
                        await recommendSabziFlow();
                    } else if (optionText === "Logout") {
                        appendMessage('bot', "Logged out successfully. Goodbye!");
                        setTimeout(() => showAuthScreen(), 1500);
                    } else {
                        currentMemberName = optionText;
                        await selectVegetablesFlow(optionText);
                    }
                    break;
                case 'select_veg':
                    if (optionText === "Back to Main Menu") {
                        showMainMenu();
                    } else if (optionText === "What to Cook Today?") {
                        await recommendSabziFlow();
                    } else if (optionText === "Logout") {
                        appendMessage('bot', "Logged out successfully. Goodbye!");
                        setTimeout(() => showAuthScreen(), 1500);
                    }
                    break;
                case 'select_present_members':
                    if (optionText === "Back to Main Menu") {
                        showMainMenu();
                    } else if (optionText === "What to Cook Today?") {
                        await recommendSabziFlow();
                    } else if (optionText === "Logout") {
                        appendMessage('bot', "Logged out successfully. Goodbye!");
                        setTimeout(() => showAuthScreen(), 1500);
                    }
                    break;
                default:
                    appendMessage('bot', "I'm not sure how to respond to that option. Please try again.");
                    showMainMenu();
                    break;
            }
        }

        // --- Family Management Functions ---
        async function manageFamilyStartFlow() {
            chatMessages.innerHTML = '';
            currentFlow = 'manage_family_choice';
            currentMemberName = '';
            memberVegetableCheckboxes = {};
            const response = await fetchAPI('/api/family_members');
            if (response.status === 'error') {
                showMainMenu();
                return;
            }

            const members = response.family_members || [];
            let memberNames = members.map(m => m.name);
            
            let options = [];
            if (memberNames.length > 0) {
                appendMessage('bot', `You currently have ${memberNames.length} family member(s) registered.`);
                options.push("Update Existing Member's Preferences");
            } else {
                appendMessage('bot', "You don't have any family members added yet.");
            }
            options.push("Add New Member");
            options.push("Back to Main Menu");

            appendMessage('bot', "How would you like to manage your family members?", options);
        }
        
        async function selectExistingMemberFlow() {
            currentFlow = 'select_existing_member';
            currentMemberName = '';
            memberVegetableCheckboxes = {};
            const response = await fetchAPI('/api/family_members');
            if (response.status === 'error') {
                showMainMenu();
                return;
            }
            const members = response.family_members || [];
            if (members.length === 0) {
                appendMessage('bot', "No existing members found. Please add a new member first.");
                await manageFamilyStartFlow();
                return;
            }

            let memberNames = members.map(m => m.name);
            appendMessage('bot', "Which member would you like to update?");
            displayOptions(memberNames.concat(["Back to Main Menu", "What to Cook Today?", "Logout"]));
        }

        async function addNewMemberNameFlow() {
            currentFlow = 'enter_new_member_name';
            currentMemberName = '';
            memberVegetableCheckboxes = {};
            toggleInput(false, true);
            newMemberNameInput.value = '';
            appendMessage('bot', "Please type the name of the new family member you'd like to add.");
            displayOptions(["Back to Main Menu"]);
        }

        nextButton.addEventListener('click', async () => {
            const newName = newMemberNameInput.value.trim();
            if (!newName) {
                appendMessage('bot', "Member name cannot be empty. Please enter a name.");
                return;
            }
            const existingMembersResponse = await fetchAPI('/api/family_members');
            if (existingMembersResponse.status !== 'error') {
                const existingNames = (existingMembersResponse.family_members || []).map(m => m.name.toLowerCase());
                if (existingNames.includes(newName.toLowerCase())) {
                    appendMessage('bot', `'${newName}' already exists. Please update the existing member or choose a different name.`);
                    return;
                }
            }
            
            appendMessage('user', newName);
            currentMemberName = newName;
            await selectVegetablesFlow(newName);
            toggleInput(false, false);
        });
        
        async function selectVegetablesFlow(memberName) {
            currentFlow = 'select_veg';
            toggleInput(false, false);
            currentMemberName = memberName;
            memberVegetableCheckboxes = {};

            const allVegResponse = await fetchAPI('/api/vegetables');
            if (!Array.isArray(allVegResponse)) {
                showMainMenu();
                return;
            }
            allVegetables = allVegResponse;

            const memberDataResponse = await fetchAPI('/api/family_members');
            let currentFavs = [];
            if (memberDataResponse.status !== 'error') {
                const memberInfo = (memberDataResponse.family_members || []).find(m => m.name.toLowerCase() === memberName.toLowerCase());
                if (memberInfo) {
                    currentFavs = memberInfo.favorite_vegetables;
                }
            }
            
            let checkboxHtml = `
                <p>Select ${memberName}'s favorite vegetables:</p>
                <div class="checkbox-group">
            `;
            memberVegetableCheckboxes = {};
            allVegetables.forEach(veg => {
                const isChecked = currentFavs.includes(veg) ? 'checked' : '';
                const id = `veg-${veg.replace(/[^a-zA-Z0-9]/g, '')}`;
                checkboxHtml += `
                    <label for="${id}">
                        <input type="checkbox" id="${id}" value="${veg}" ${isChecked}>
                        ${veg}
                    </label>
                `;
            });
            checkboxHtml += `</div>
                <div class="checkbox-buttons">
                    <button class="save-button" id="save-veg-button">Save Favorites</button>
                </div>
            `;
            
            appendMessage('bot', '', [], checkboxHtml); 
            displayOptions(["Back to Main Menu", "What to Cook Today?", "Logout"]);

            setTimeout(() => {
                const saveBtn = document.getElementById('save-veg-button');
                if (saveBtn) {
                    saveBtn.onclick = async () => {
                        const selectedVeggies = Array.from(document.querySelectorAll('.checkbox-group input[type=\"checkbox\"]:checked'))
                                                    .map(checkbox => checkbox.value);
                        if (selectedVeggies.length === 0) {
                            appendMessage('bot', "Please select at least one favorite vegetable.");
                            return;
                        }
                        const saveResponse = await fetchAPI('/api/set_preferences', 'POST', {
                            member_name: memberName,
                            favorite_vegetables: selectedVeggies
                        });
                        if (saveResponse.status === 'success') {
                            appendMessage('bot', saveResponse.message);
                            currentMemberName = '';
                            memberVegetableCheckboxes = {};
                            displayOptions(["Back to Main Menu", "What to Cook Today?", "Logout"]);
                        } else {
                            appendMessage('bot', `Failed to save preferences: ${saveResponse.message || 'Unknown error'}. Please try again.`);
                        }
                    };
                }
            }, 0);
        }

        async function recommendSabziFlow() {
            chatMessages.innerHTML = '';
            currentFlow = 'select_present_members';
            toggleInput(false, false);

            let presentMemberCheckboxes = {};

            const response = await fetchAPI('/api/family_members');
            if (response.status === 'error') {
                showMainMenu();
                return;
            }
            const members = response.family_members || [];
            if (members.length === 0) {
                appendMessage('bot', "No family members added yet. Please add members first via 'Manage Family & Favorite Vegetables' option.");
                showMainMenu();
                return;
            }

            let memberNames = members.map(m => m.name);
            let checkboxHtml = `
                <p>Who is present today?</p>
                <div class="checkbox-group">
            `;
            memberNames.forEach(name => {
                const id = `present-member-${name.replace(/[^a-zA-Z0-9]/g, '')}`;
                checkboxHtml += `
                    <label for="${id}">
                        <input type="checkbox" id="${id}" value="${name}">
                        ${name}
                    </label>
                `;
            });
            checkboxHtml += `</div>
                <div class="checkbox-buttons">
                    <button class="save-button" id="get-recommendation-button">Get Recommendation</button>
                </div>
            `;
            appendMessage('bot', '', [], checkboxHtml);

            displayOptions(["Back to Main Menu", "Logout"]);

            setTimeout(() => {
                const getRecBtn = document.getElementById('get-recommendation-button');
                if (getRecBtn) {
                    getRecBtn.onclick = async () => {
                        const presentMembers = Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked'))
                                                    .map(checkbox => checkbox.value);
                        if (presentMembers.length === 0) {
                            appendMessage('bot', "Please select at least one member present today.");
                            return;
                        }
                        const allBotMessages = chatMessages.querySelectorAll('.message.bot');
                        if (allBotMessages.length > 1) {
                            allBotMessages[allBotMessages.length - 1].remove();
                        }
                        const recommendationResponse = await fetchAPI('/api/recommend_sabzi', 'POST', { present_members: presentMembers });
                        if (recommendationResponse.status === 'success' || recommendationResponse.status === 'warning' || recommendationResponse.status === 'info') {
                            appendMessage('bot', recommendationResponse.recommendation || recommendationResponse.message);
                        } else {
                            appendMessage('bot', `Sorry, I couldn't get a recommendation: ${recommendationResponse.message || 'Unknown error'}.`);
                        }
                        displayOptions(["Back to Main Menu", "What to Cook Today?", "Logout"]);
                    };
                }
            }, 0);
        }

        // Show main menu after login/register success
        function showMainMenuAfterAuthSuccess(successMsg) {
            removeAllFormBubbles();
            appendMessage('bot', successMsg, [
                "Manage Family & Favorite Vegetables",
                "What to Cook Today?",
                "Current Season Vegetables",
                "Logout"
            ]);
            currentFlow = 'main_menu';
            isLoggedIn = true;
        }

        // Event Listeners
        sendButton.addEventListener('click', sendUserMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendUserMessage();
            }
        });

        function sendUserMessage() {
            // Not implemented. This is a placeholder to prevent errors.
        }

        // Initialize the app
        showAuthScreen();
    </script>
</body>
</html>